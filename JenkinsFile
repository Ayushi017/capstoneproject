pipeline {
    agent any
    
    environment {
        GITHUB_REPO = 'Ayushi017/capstoneproject'
        AWS_APP_IP = '3.86.193.231'  // Your AWS App Machine IP
        AZURE_APP_IP = '20.185.61.158'  // Your Azure VM IP
        AZURE_CREDENTIALS = credentials('azure-credentials')
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Deploy to AWS') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'my-ssh-key', keyFileVariable: 'SSH_KEY')]) {
                    sh '''
                        echo "Starting deployment to AWS..."
                        scp -i $SSH_KEY -o StrictHostKeyChecking=no index-aws.html ubuntu@${AWS_APP_IP}:/tmp/
                        ssh -i $SSH_KEY -o StrictHostKeyChecking=no ubuntu@${AWS_APP_IP} "sudo mv /tmp/index-aws.html /var/www/html/ && sudo systemctl restart nginx"
                        echo "Deployment completed. Checking Nginx status..."
                        ssh -i $SSH_KEY -o StrictHostKeyChecking=no ubuntu@${AWS_APP_IP} "sudo systemctl status nginx"
                        echo "Nginx logs:"
                        ssh -i $SSH_KEY -o StrictHostKeyChecking=no ubuntu@${AWS_APP_IP} "sudo tail -n 50 /var/log/nginx/access.log"
                        ssh -i $SSH_KEY -o StrictHostKeyChecking=no ubuntu@${AWS_APP_IP} "sudo tail -n 50 /var/log/nginx/error.log"
                    '''
                }
            }
        }
        
        stage('Deploy to Azure') {
            steps {
                sh '''
                    echo "Starting deployment to Azure..."
                    # Create expect script for automated SSH
                    cat > deploy_azure.exp << 'EOF'
                    #!/usr/bin/expect -f
                    set timeout 30
                    spawn scp -o StrictHostKeyChecking=no index-azure.html azureuser@${AZURE_APP_IP}:/tmp/
                    expect "password:"
                    send "$AZURE_CREDENTIALS\r"
                    expect eof
                    EOF
                    
                    chmod +x deploy_azure.exp
                    ./deploy_azure.exp
                    
                    # Create expect script for SSH commands
                    cat > ssh_azure.exp << 'EOF'
                    #!/usr/bin/expect -f
                    set timeout 30
                    spawn ssh -o StrictHostKeyChecking=no azureuser@${AZURE_APP_IP}
                    expect "password:"
                    send "$AZURE_CREDENTIALS\r"
                    expect "$ "
                    send "sudo mv /tmp/index-azure.html /var/www/html/ && sudo systemctl restart nginx\r"
                    expect "password:"
                    send "$AZURE_CREDENTIALS\r"
                    expect "$ "
                    send "sudo systemctl status nginx\r"
                    expect "password:"
                    send "$AZURE_CREDENTIALS\r"
                    expect "$ "
                    send "exit\r"
                    expect eof
                    EOF
                    
                    chmod +x ssh_azure.exp
                    ./ssh_azure.exp
                    
                    echo "Azure deployment completed"
                '''
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            echo 'Deployment completed successfully!'
        }
        failure {
            echo 'Deployment failed!'
        }
    }
} 
